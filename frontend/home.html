<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Social Media</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* same styles as before */
    /* (CSS is unchanged – skipped for brevity) */
  </style>
</head>
<body>

  <nav>
    <h2>🌟 Mini Social Media</h2>
    <div class="navtab">
      <button onclick="goToProfile()">👤 Profile</button>
      <button onclick="goToCreatePost()">➕ New Post</button>
      <button onclick="logout()">🚪 Logout</button>
    </div>
  </nav>

  <div id="feed">Loading posts...</div>

  <script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));

    if (!token) {
      alert("Not logged in!");
      window.location.href = "/auth.html";
    }

    async function fetchPosts() {
      try {
        const res = await fetch("/posts", {
          headers: { Authorization: "Bearer " + token }
        });
        if (!res.ok) throw new Error("Failed to fetch posts");

        const posts = await res.json();
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        posts.forEach(post => {
          const postDiv = document.createElement("div");
          postDiv.className = "post";
          const isOwner = post.userId._id === user.id || post.userId === user.id;

          postDiv.innerHTML = `
            <div class="username">👤 ${post.userId.username}</div>
            ${post.imageUrl ? `<img src="/uploads/${post.imageUrl}" alt="Post Image" style="max-width:100%; border-radius: 10px; margin: 10px 0;" />` : ""}
            <div class="content">${post.content}</div>
            <div class="likes-comments">❤️ ${post.likes.length} likes</div>
            <button class="like-btn" onclick="likePost('${post._id}', event)">
              ${post.likes.includes(user.id) ? "👎 Unlike" : "👍 Like"}
            </button>
            ${isOwner ? `<button class="delete-btn" onclick="deletePost('${post._id}')">🗑 Delete</button>` : ''}
            <button class="view-profile-btn" onclick="viewUserProfile('${post.userId._id}')">🔍 View Profile</button>
            <div class="comment-section">
              <div id="comment-list-${post._id}">Loading comments...</div>
              <input type="text" id="comment-input-${post._id}" placeholder="Write a comment..." />
              <button class="comment-btn" onclick="addComment('${post._id}')">💬 Comment</button>
            </div>
          `;
          feed.appendChild(postDiv);
          loadComments(post._id);
        });

      } catch (err) {
        console.error(err);
        document.getElementById("feed").innerText = "Error loading posts.";
      }
    }

    async function likePost(postId) {
      try {
        const res = await fetch(`/posts/${postId}/like`, {
          method: "POST",
          headers: { Authorization: "Bearer " + token }
        });
        if (!res.ok) throw new Error("Failed to like/unlike post");
        fetchPosts();
      } catch (err) {
        console.error(err);
        alert("Could not like/unlike post.");
      }
    }

    async function deletePost(postId) {
      if (!confirm("Are you sure you want to delete this post?")) return;
      try {
        const res = await fetch(`/posts/${postId}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token }
        });
        const data = await res.json();
        alert(data.message);
        fetchPosts();
      } catch (err) {
        alert("Error deleting post.");
      }
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "/auth.html";
    }

    function viewUserProfile(userId) {
      window.location.href = `/profile.html?id=${userId}`;
    }

    function goToProfile() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (user?.id) {
        window.location.href = `/profile.html?id=${user.id}`;
      }
    }

    function goToCreatePost() {
      window.location.href = "/createpost.html";
    }

    async function loadComments(postId) {
      try {
        const res = await fetch(`/comments/${postId}`, {
          headers: { Authorization: "Bearer " + token }
        });
        const comments = await res.json();
        const list = comments.map(c => {
          const canEdit = c.userId._id === user.id || c.userId === user.id;
          return `
            <div class="comment">
              🗨️ <b>${c.userId.username}:</b> ${c.text}
              ${canEdit ? `<button class="edit-btn" onclick="editComment('${c._id}', '${postId}', '${c.text.replace(/'/g, "\\'")}')">✏️ Edit</button>` : ''}
            </div>`;
        }).join('');
        document.getElementById(`comment-list-${postId}`).innerHTML = list || "<i>No comments yet</i>";
      } catch {
        document.getElementById(`comment-list-${postId}`).innerText = "Error loading comments.";
      }
    }

    async function addComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      if (!text) return;
      try {
        const res = await fetch(`/comments/${postId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ text })
        });
        if (!res.ok) throw new Error();
        input.value = "";
        loadComments(postId);
      } catch {
        alert("Could not add comment.");
      }
    }

    async function editComment(commentId, postId, oldText) {
      const newText = prompt("Edit your comment:", oldText);
      if (!newText || newText === oldText) return;
      try {
        const res = await fetch(`/comments/${commentId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ text: newText })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);
        alert("Comment updated!");
        loadComments(postId);
      } catch {
        alert("Error editing comment.");
      }
    }

    fetchPosts();
  </script>
</body>
</html>
